{% extends "base.html" %}

{% block title %}{{ entity.name }} - Arcane Arsenal{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Entities</a> / {{ entity.name }}
</div>

<div class="entity-header">
    <h2>{{ entity.name }}</h2>
    {% if entity.is_active() %}
    <form method="POST" action="/entity/{{ entity.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this entity?');">
        <button type="submit" class="btn btn-danger">Delete Entity</button>
    </form>
    {% endif %}
</div>

<div class="entity-info">
    <p><strong>ID:</strong> <code>{{ entity.id }}</code></p>
    <p><strong>Created:</strong> {{ entity.created_at }}</p>
    <p><strong>Modified:</strong> {{ entity.modified_at }}</p>
    {% if not entity.is_active() %}
        <p class="deleted"><strong>Status:</strong> DELETED</p>
    {% endif %}
</div>

<section class="components">
    <div class="section-header">
        <h3>Components</h3>
        {% if entity.is_active() %}
        <button class="btn btn-primary" onclick="toggleForm('add-component-form')">+ Add Component</button>
        {% endif %}
    </div>

    {% if entity.is_active() %}
    <div id="add-component-form" class="form-card" style="display: none;">
        <h4>Add Component</h4>
        <form method="POST" action="/entity/{{ entity.id }}/component/add">
            <div class="form-group">
                <label for="component_type">Component Type:</label>
                <select id="component_type" name="component_type" required onchange="updateComponentExample(this.value)">
                    <option value="">Select a type...</option>
                    {% for type in component_types %}
                        <option value="{{ type.type }}" data-description="{{ type.description }}">
                            {{ type.type }} - {{ type.description }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="component_data">Component Data (JSON):</label>
                <textarea id="component_data" name="component_data" required rows="6" placeholder='{"key": "value"}'></textarea>
                <div id="component-example" class="help-text"></div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Add Component</button>
                <button type="button" class="btn btn-secondary" onclick="toggleForm('add-component-form')">Cancel</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if components %}
        {% for type, data in components.items() %}
            <div class="component-card">
                <div class="component-header">
                    <h4>{{ type }}</h4>
                    {% if entity.is_active() %}
                    <div class="component-actions">
                        <button class="btn btn-small" onclick="editComponent('{{ type }}', {{ data | tojson | safe }})">Edit</button>
                        <form method="POST" action="/entity/{{ entity.id }}/component/{{ type }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this component?');">
                            <button type="submit" class="btn btn-small btn-danger">Delete</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                <pre id="component-{{ type }}">{{ data | tojson(indent=2) }}</pre>

                {% if entity.is_active() %}
                <div id="edit-{{ type }}" class="edit-form" style="display: none;">
                    <form method="POST" action="/entity/{{ entity.id }}/component/{{ type }}/update">
                        <div class="form-group">
                            <label>Update {{ type }} Data (JSON):</label>
                            <textarea name="component_data" rows="6" required>{{ data | tojson(indent=2) }}</textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('{{ type }}')">Cancel</button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p class="no-data">No components yet.</p>
    {% endif %}
</section>

<section class="relationships">
    <div class="section-header">
        <h3>Relationships</h3>
        {% if entity.is_active() %}
        <button class="btn btn-primary" onclick="toggleForm('add-relationship-form')">+ Add Relationship</button>
        {% endif %}
    </div>

    {% if entity.is_active() %}
    <div id="add-relationship-form" class="form-card" style="display: none;">
        <h4>Create Relationship</h4>
        <form method="POST" action="/relationship/create">
            <input type="hidden" name="from_entity" value="{{ entity.id }}">
            <div class="form-group">
                <label for="to_entity">To Entity:</label>
                <select id="to_entity" name="to_entity" required>
                    <option value="">Select an entity...</option>
                    {% for e in all_entities %}
                        {% if e.id != entity.id and e.is_active() %}
                            <option value="{{ e.id }}">{{ e.name }} ({{ e.id }})</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="relationship_type">Relationship Type:</label>
                <select id="relationship_type" name="relationship_type" required>
                    <option value="">Select a type...</option>
                    {% for type in relationship_types %}
                        <option value="{{ type.type }}">{{ type.type }} - {{ type.description }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="metadata">Metadata (JSON, optional):</label>
                <textarea id="metadata" name="metadata" rows="3" placeholder='{"key": "value"}'></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create Relationship</button>
                <button type="button" class="btn btn-secondary" onclick="toggleForm('add-relationship-form')">Cancel</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if outgoing %}
    <div class="relationship-group">
        <h4>Outgoing</h4>
        <ul>
            {% for item in outgoing %}
            <li>
                <div class="relationship-item">
                    <div class="relationship-content">
                        <code>{{ entity.name }}</code>
                        → <strong>{{ item.rel.relationship_type }}</strong> →
                        <a href="/entity/{{ item.other.id }}">{{ item.other.name }}</a>
                        {% if item.rel.metadata %}
                            <pre class="metadata">{{ item.rel.metadata | tojson }}</pre>
                        {% endif %}
                    </div>
                    {% if entity.is_active() %}
                    <form method="POST" action="/relationship/{{ item.rel.id }}/delete" style="display: inline;" onsubmit="return confirm('Delete this relationship?');">
                        <button type="submit" class="btn btn-small btn-danger">Delete</button>
                    </form>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if incoming %}
    <div class="relationship-group">
        <h4>Incoming</h4>
        <ul>
            {% for item in incoming %}
            <li>
                <div class="relationship-item">
                    <div class="relationship-content">
                        <a href="/entity/{{ item.other.id }}">{{ item.other.name }}</a>
                        → <strong>{{ item.rel.relationship_type }}</strong> →
                        <code>{{ entity.name }}</code>
                        {% if item.rel.metadata %}
                            <pre class="metadata">{{ item.rel.metadata | tojson }}</pre>
                        {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if not outgoing and not incoming %}
        <p class="no-data">No relationships yet.</p>
    {% endif %}
</section>

{% if events %}
<section class="events">
    <h3>Recent Events</h3>
    <ul>
        {% for event in events %}
        <li>
            <span class="timestamp">{{ event.timestamp }}</span>
            <strong>{{ event.event_type }}</strong>
            {% if event.actor_id %}
                <span class="actor">by {{ event.actor_id }}</span>
            {% endif %}
            <pre class="event-data">{{ event.data | tojson }}</pre>
        </li>
        {% endfor %}
    </ul>
</section>
{% endif %}

<script>
function toggleForm(formId) {
    const form = document.getElementById(formId);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}

function editComponent(type, data) {
    document.getElementById('component-' + type).style.display = 'none';
    document.getElementById('edit-' + type).style.display = 'block';
}

function cancelEdit(type) {
    document.getElementById('component-' + type).style.display = 'block';
    document.getElementById('edit-' + type).style.display = 'none';
}

function updateComponentExample(type) {
    const example = document.getElementById('component-example');
    if (type === 'Identity') {
        example.innerHTML = 'Example: {"description": "A brave warrior", "tags": ["player", "human"]}';
    } else if (type === 'Position') {
        example.innerHTML = 'Example: {"x": 100, "y": 200, "z": 0, "region": "tavern"}';
    } else {
        example.innerHTML = '';
    }
}
</script>
{% endblock %}
