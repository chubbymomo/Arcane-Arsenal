{% extends "base.html" %}

{% block title %}{{ entity.name }} - Character Sheet{% endblock %}

{% block content %}
<div class="character-sheet-container" x-data="diceRoller()" x-init="entityId = '{{ entity.id }}'">
    <!-- Header -->
    <div class="sheet-header">
        <div>
            <h1 class="character-name">{{ entity.name }}</h1>
            <p class="character-description">{{ identity.description }}</p>
        </div>
        <a href="{{ url_for('client.index') }}" class="btn-back">‚Üê Back to Characters</a>
    </div>

    <!-- 3-Column Layout -->
    <div class="sheet-grid">
        <!-- LEFT COLUMN: Core Stats & Checks -->
        <div class="column-left" x-data="{ coreOpen: true, skillsOpen: true }">
            <h2 class="column-title">‚ö° Stats & Checks</h2>

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'CORE' %}
                    <div class="component-card {% if comp_type == 'Attributes' %}non-collapsible{% endif %}">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'SKILLS' %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>

        <!-- CENTER COLUMN: Combat & Actions -->
        <div class="column-center" x-data="{ combatOpen: true, resourcesOpen: true }">
            <h2 class="column-title">‚öîÔ∏è Combat & Actions</h2>

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'COMBAT' %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'RESOURCES' %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            <!-- Collapsible Roll History (D&D Beyond style) - Only if RNG module loaded -->
            {% if rng_enabled %}
            <div class="component-card roll-history-card">
                <h3 class="component-title" @click="historyOpen = !historyOpen" style="cursor: pointer;"
                    :data-collapsed="!historyOpen">
                    üé≤ Roll History
                </h3>
                <div x-show="historyOpen" x-transition class="roll-history">
                    <p x-show="history.length === 0" class="roll-history-empty">No rolls yet. Click any üé≤ button to roll!</p>

                    <template x-for="(roll, index) in history" :key="index">
                        <div class="roll-entry roll-success">
                            <div class="roll-label" x-text="roll.purpose || 'Roll'"></div>
                            <div class="roll-total"
                                 :class="{
                                     'critical-success': roll.critical_success,
                                     'critical-failure': roll.critical_failure
                                 }"
                                 x-text="roll.total">
                            </div>
                            <div class="roll-breakdown" x-text="roll.breakdown"></div>
                        </div>
                    </template>
                </div>
                <p x-show="!historyOpen" class="help-text" style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                    Click to view roll history (stored in database)
                </p>
            </div>
            {% endif %}

            <!-- Dice roll toasts - Only if RNG module loaded -->
            {% if rng_enabled %}
            <!-- Rolling indicator toast -->
            <div x-show="rolling"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-90"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="roll-toast"
                 style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
                <div class="roll-toast-content">
                    <div class="roll-status">üé≤ Rolling...</div>
                </div>
            </div>

            <!-- Result toast (shows after rolling completes) -->
            <div x-show="!rolling && result"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-90"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-500"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="roll-toast"
                 style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
                <div class="roll-toast-content">
                    <div class="roll-toast-label" x-text="result?.purpose || 'Roll'"></div>
                    <div class="roll-toast-total"
                         :class="{
                             'critical-success': result?.critical_success,
                             'critical-failure': result?.critical_failure
                         }"
                         x-text="result?.total">
                    </div>
                    <div class="roll-toast-breakdown" x-text="result?.breakdown"></div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- RIGHT COLUMN: Info & Inventory -->
        <div class="column-right" x-data="{ infoOpen: true, inventoryOpen: true }">
            <h2 class="column-title">üìã Info & Inventory</h2>

            <!-- Character Info -->
            <div class="component-card">
                <h3 class="component-title">Character Info</h3>
                <dl class="info-list">
                    <dt>Name</dt>
                    <dd>{{ entity.name }}</dd>
                    <dt>Entity ID</dt>
                    <dd class="mono">{{ entity.id[:16] }}...</dd>
                    <dt>Created</dt>
                    <dd>{{ entity.created_at.strftime('%Y-%m-%d') }}</dd>
                </dl>
            </div>

            {% if position %}
            <div class="component-card">
                <h3 class="component-title">üìç Location</h3>
                <dl class="info-list">
                    <dt>Region</dt>
                    <dd>{{ position.region or 'Unknown' }}</dd>
                    <dt>Coordinates</dt>
                    <dd class="mono">({{ position.x }}, {{ position.y }}, {{ position.z }})</dd>
                </dl>
            </div>
            {% endif %}

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category in ['INVENTORY', 'INFO', 'MISC'] %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% if nearby_entities %}
            <div class="component-card">
                <h3 class="component-title">üë• Nearby</h3>
                <ul class="entity-list">
                    {% for nearby in nearby_entities %}
                        <li>{{ nearby.name }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- WebSocket Room Joining & Character State -->
<script>
// Join entity room for real-time updates
document.addEventListener('DOMContentLoaded', function() {
    const entityId = '{{ entity.id }}';
    const worldName = '{{ session.get("world_name", "") }}';

    // Join entity-specific room
    socket.emit('join_entity', { entity_id: entityId });

    // Join world room if available
    if (worldName) {
        socket.emit('join_world', { world_name: worldName });
    }

    console.log(`‚úÖ Joined rooms: entity_${entityId}, world_${worldName}`);

    // Make component cards collapsible (click title to toggle)
    document.querySelectorAll('.component-card').forEach(card => {
        // Skip non-collapsible cards (like Attributes)
        if (card.classList.contains('non-collapsible')) {
            return;
        }

        const title = card.querySelector('.component-title');
        if (!title) return;

        // Wrap content after title in a collapsible div
        const content = Array.from(card.childNodes).filter(node => node !== title);
        const wrapper = document.createElement('div');
        wrapper.className = 'component-content';
        wrapper.setAttribute('x-show', 'open');
        wrapper.setAttribute('x-transition', '');

        // Move all content after title into wrapper
        content.forEach(node => {
            if (node !== title) {
                wrapper.appendChild(node);
            }
        });
        card.appendChild(wrapper);

        // Add Alpine data for collapsible state (default open)
        card.setAttribute('x-data', '{ open: true }');
        title.setAttribute('x-on:click', 'open = !open');
        title.setAttribute(':data-collapsed', '!open');
    });
});
</script>

<!-- Character Sheet Styles -->
<style>
.character-sheet-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
}

/* Collapsible Component Cards */
.component-title {
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
}

.component-title:hover {
    color: var(--accent);
}

.component-title::before {
    content: '‚ñº ';
    font-size: 0.8em;
    transition: transform 0.2s;
    display: inline-block;
}

.component-title[data-collapsed="true"]::before {
    transform: rotate(-90deg);
}

.component-content {
    overflow: hidden;
}

/* Non-collapsible Cards (like Attributes) */
.non-collapsible .component-title {
    cursor: default !important;
}

.non-collapsible .component-title::before {
    display: none;
}

/* Roll History Card - Special Styling */
.roll-history-card {
    background: linear-gradient(145deg, var(--surface-1), var(--surface-2));
    border: 2px solid var(--primary-color);
}

.roll-history-card .component-title {
    color: var(--primary-color);
}

/* Header */
.sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 3px solid var(--primary-color);
}

.character-name {
    margin: 0;
    font-family: 'Cinzel', serif;
    font-size: 2.5rem;
    color: var(--primary-color);
    letter-spacing: 0.05em;
}

.character-description {
    margin: 0.5rem 0 0 0;
    color: var(--text-muted);
    font-size: 1.1rem;
    font-style: italic;
}

.btn-back {
    color: var(--accent);
    text-decoration: none;
    font-size: 1rem;
    transition: color 0.2s;
}

.btn-back:hover {
    color: var(--primary-color);
}

/* 3-Column Grid */
.sheet-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 1200px) {
    .sheet-grid {
        grid-template-columns: 1fr 1fr;
    }
    .column-right {
        grid-column: 1 / -1;
    }
}

@media (max-width: 768px) {
    .sheet-grid {
        grid-template-columns: 1fr;
    }
}

.column-left, .column-center, .column-right {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.column-title {
    font-family: 'Cinzel', serif;
    font-size: 1.3rem;
    color: var(--primary-color);
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
    letter-spacing: 0.05em;
}

/* Component Cards */
.component-card {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.25rem;
}

.component-title {
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    color: var(--primary-color);
    margin: 0 0 1rem 0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

/* Attributes Grid */
.attributes-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.attribute-card {
    background: linear-gradient(135deg, var(--background-color) 0%, var(--card-background) 100%);
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 0.75rem;
    text-align: center;
    transition: transform 0.2s, border-color 0.2s;
}

.attribute-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-color);
}

.attribute-label {
    font-weight: bold;
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.attribute-score {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-color);
    margin: 0.25rem 0;
}

.attribute-modifier {
    font-size: 1.1rem;
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

/* Dice Roll Buttons */
.btn-roll-dice {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
}

.btn-roll-dice:hover {
    background: var(--accent);
    transform: scale(1.05);
}

.btn-roll-dice:active {
    transform: scale(0.95);
}

.btn-roll-dice.inline {
    padding: 0.2rem 0.5rem;
    font-size: 0.85rem;
    margin-left: 0.5rem;
}

/* Weapon Cards */
.weapon-card {
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.weapon-card:last-child {
    margin-bottom: 0;
}

.weapon-name {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--primary-color);
    margin-bottom: 0.75rem;
}

.weapon-stats {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.weapon-stat {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
}

.stat-label {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.stat-value {
    flex: 1;
    color: var(--text-color);
}

/* Armor Display */
.armor-display {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.armor-stat {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
    background: var(--background-color);
    border-radius: 4px;
}

/* Health Display */
.health-display {
    margin-top: 0.5rem;
}

.hp-bar-container {
    position: relative;
    background: var(--background-color);
    border: 2px solid var(--border-color);
    border-radius: 8px;
    height: 40px;
    overflow: hidden;
}

.hp-bar {
    height: 100%;
    transition: width 0.3s, background-color 0.3s;
}

.hp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--text-color);
    text-shadow: 0 0 3px rgba(255,255,255,0.8);
}

.temp-hp {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #2196f3;
    color: white;
    border-radius: 4px;
    text-align: center;
    font-weight: 600;
}

/* Info Lists */
.info-list {
    margin: 0;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem 1rem;
}

.info-list dt {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.info-list dd {
    margin: 0;
    color: var(--text-color);
}

.entity-list {
    margin: 0;
    padding: 0;
    list-style: none;
}

.entity-list li {
    padding: 0.5rem;
    background: var(--background-color);
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.entity-list li:last-child {
    margin-bottom: 0;
}

.mono {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

/* Roll History */
.roll-history {
    max-height: 400px;
    overflow-y: auto;
}

.roll-history-empty {
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
    padding: 2rem;
}

.roll-entry {
    background: linear-gradient(135deg, var(--surface-2), var(--surface-3));
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: all 0.3s;
}

.roll-entry:last-child {
    margin-bottom: 0;
}

.roll-entry.roll-rolling {
    border-color: var(--info);
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(52, 152, 219, 0.1));
}

.roll-entry.roll-success {
    border-color: var(--success);
}

.roll-entry.roll-error {
    border-color: var(--error);
    background: linear-gradient(135deg, rgba(192, 57, 43, 0.2), rgba(192, 57, 43, 0.1));
}

.roll-animate {
    animation: rollPulse 0.5s;
}

@keyframes rollPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.roll-label {
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.roll-notation {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.roll-total {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-color);
    text-align: center;
    margin: 0.5rem 0;
}

.roll-total.critical-success {
    color: #4caf50;
    text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
}

.roll-total.critical-failure {
    color: #f44336;
    text-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
}

.roll-breakdown {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
}

/* Roll Toast (D&D Beyond style) */
.roll-toast {
    pointer-events: none;
}

.roll-toast-content {
    background: linear-gradient(135deg, var(--surface-1) 0%, var(--surface-2) 100%);
    border: 3px solid var(--primary-color);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 8px 32px var(--shadow), 0 0 20px rgba(212, 175, 55, 0.4);
    min-width: 250px;
    text-align: center;
}

.roll-toast-label {
    font-weight: bold;
    color: var(--primary-color);
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.roll-toast-total {
    font-size: 3rem;
    font-weight: bold;
    color: var(--text-color);
    margin: 0.5rem 0;
    line-height: 1;
}

.roll-toast-total.critical-success {
    color: #4caf50;
    text-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
    animation: criticalPulse 1s infinite;
}

.roll-toast-total.critical-failure {
    color: #f44336;
    text-shadow: 0 0 20px rgba(244, 67, 54, 0.6);
    animation: criticalPulse 1s infinite;
}

@keyframes criticalPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.roll-toast-breakdown {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
}

.roll-status {
    font-style: italic;
    color: var(--text-muted);
}

.roll-error {
    color: #f44336;
    font-weight: 600;
}

/* Component Display Data */
.component-data {
    margin: 0;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem 1rem;
}

.component-data dt {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.component-data dd {
    margin: 0;
    color: var(--text-color);
}
</style>
{% endblock %}
