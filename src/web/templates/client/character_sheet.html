{% extends "base.html" %}

{% block title %}{{ entity.name }} - Character Sheet{% endblock %}

{% block content %}
<div class="character-sheet-container">
    <!-- Header -->
    <div class="sheet-header">
        <div>
            <h1 class="character-name">{{ entity.name }}</h1>
            <p class="character-description">{{ identity.description }}</p>
        </div>
        <a href="{{ url_for('client.index') }}" class="btn-back">‚Üê Back to Characters</a>
    </div>

    <!-- 3-Column Layout -->
    <div class="sheet-grid">
        <!-- LEFT COLUMN: Core Stats & Checks -->
        <div class="column-left">
            <h2 class="column-title">‚ö° Stats & Checks</h2>

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'CORE' %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_character_sheet_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'SKILLS' %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_character_sheet_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>

        <!-- CENTER COLUMN: Combat & Actions -->
        <div class="column-center">
            <h2 class="column-title">‚öîÔ∏è Combat & Actions</h2>

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'COMBAT' %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_character_sheet_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category == 'RESOURCES' %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_character_sheet_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            <!-- Roll History Log -->
            <div class="component-card roll-history-card">
                <h3 class="component-title">üé≤ Roll History</h3>
                <div id="roll-history" class="roll-history">
                    <p class="roll-history-empty">No rolls yet. Click any üé≤ button to roll!</p>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Info & Inventory -->
        <div class="column-right">
            <h2 class="column-title">üìã Info & Inventory</h2>

            <!-- Character Info -->
            <div class="component-card">
                <h3 class="component-title">Character Info</h3>
                <dl class="info-list">
                    <dt>Name</dt>
                    <dd>{{ entity.name }}</dd>
                    <dt>Entity ID</dt>
                    <dd class="mono">{{ entity.id[:16] }}...</dd>
                    <dt>Created</dt>
                    <dd>{{ entity.created_at.strftime('%Y-%m-%d') }}</dd>
                </dl>
            </div>

            {% if position %}
            <div class="component-card">
                <h3 class="component-title">üìç Location</h3>
                <dl class="info-list">
                    <dt>Region</dt>
                    <dd>{{ position.region or 'Unknown' }}</dd>
                    <dt>Coordinates</dt>
                    <dd class="mono">({{ position.x }}, {{ position.y }}, {{ position.z }})</dd>
                </dl>
            </div>
            {% endif %}

            {% for comp_type, comp_data in components.items() %}
                {% if comp_type not in ['Identity', 'Position', 'PlayerCharacter'] %}
                    {% set category = form_builder.categorize_component(comp_type, comp_data) %}
                    {% if category in ['INVENTORY', 'INFO', 'MISC'] %}
                    <div class="component-card">
                        <h3 class="component-title">{{ comp_type }}</h3>
                        {{ form_builder.build_character_sheet_display(comp_type, comp_data, entity.id) | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% if nearby_entities %}
            <div class="component-card">
                <h3 class="component-title">üë• Nearby</h3>
                <ul class="entity-list">
                    {% for nearby in nearby_entities %}
                        <li>{{ nearby.name }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Dice Rolling JavaScript -->
<script>
// Dice Roll Handler
document.addEventListener('DOMContentLoaded', function() {
    const rollHistory = document.getElementById('roll-history');
    let rollCount = 0;

    // Attach event listeners to all dice buttons
    document.querySelectorAll('.btn-roll-dice').forEach(button => {
        button.addEventListener('click', function() {
            const entityId = this.dataset.entityId;
            const notation = this.dataset.notation;
            const rollType = this.dataset.rollType;
            const label = this.dataset.label;
            const advantage = this.dataset.advantage === 'true';
            const disadvantage = this.dataset.disadvantage === 'true';

            rollDice(entityId, notation, rollType, label, advantage, disadvantage);
        });
    });

    function rollDice(entityId, notation, rollType, label, advantage = false, disadvantage = false) {
        // Show loading state
        const loadingId = addRollToHistory('rolling', label, notation);

        // Make API request
        fetch('/api/roll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                entity_id: entityId,
                notation: notation,
                roll_type: rollType,
                label: label,
                advantage: advantage,
                disadvantage: disadvantage
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateRollInHistory(loadingId, 'success', label, data.result);
            } else {
                updateRollInHistory(loadingId, 'error', label, { error: data.error });
            }
        })
        .catch(error => {
            updateRollInHistory(loadingId, 'error', label, { error: error.message });
        });
    }

    function addRollToHistory(status, label, notation) {
        rollCount++;
        const rollId = `roll-${rollCount}`;

        // Remove empty message if present
        const emptyMsg = rollHistory.querySelector('.roll-history-empty');
        if (emptyMsg) {
            emptyMsg.remove();
        }

        const rollEntry = document.createElement('div');
        rollEntry.id = rollId;
        rollEntry.className = `roll-entry roll-${status}`;
        rollEntry.innerHTML = `
            <div class="roll-label">${escapeHtml(label)}</div>
            <div class="roll-notation">${escapeHtml(notation)}</div>
            <div class="roll-status">Rolling...</div>
        `;

        // Add to top of history
        rollHistory.insertBefore(rollEntry, rollHistory.firstChild);

        // Limit history to 10 entries
        while (rollHistory.children.length > 10) {
            rollHistory.removeChild(rollHistory.lastChild);
        }

        return rollId;
    }

    function updateRollInHistory(rollId, status, label, result) {
        const rollEntry = document.getElementById(rollId);
        if (!rollEntry) return;

        rollEntry.className = `roll-entry roll-${status}`;

        if (status === 'success') {
            const total = result.total;
            const breakdown = result.breakdown;
            const natural20 = result.natural_20;
            const natural1 = result.natural_1;

            let resultClass = 'roll-total';
            if (natural20) resultClass += ' critical-success';
            if (natural1) resultClass += ' critical-failure';

            rollEntry.innerHTML = `
                <div class="roll-label">${escapeHtml(label)}</div>
                <div class="${resultClass}">${total}</div>
                <div class="roll-breakdown">${escapeHtml(breakdown)}</div>
            `;

            // Add animation
            rollEntry.classList.add('roll-animate');
            setTimeout(() => rollEntry.classList.remove('roll-animate'), 500);
        } else {
            rollEntry.innerHTML = `
                <div class="roll-label">${escapeHtml(label)}</div>
                <div class="roll-error">Error: ${escapeHtml(result.error)}</div>
            `;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>

<!-- Character Sheet Styles -->
<style>
.character-sheet-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
}

/* Header */
.sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 3px solid var(--primary-color);
}

.character-name {
    margin: 0;
    font-family: 'Cinzel', serif;
    font-size: 2.5rem;
    color: var(--primary-color);
    letter-spacing: 0.05em;
}

.character-description {
    margin: 0.5rem 0 0 0;
    color: var(--text-muted);
    font-size: 1.1rem;
    font-style: italic;
}

.btn-back {
    color: var(--accent);
    text-decoration: none;
    font-size: 1rem;
    transition: color 0.2s;
}

.btn-back:hover {
    color: var(--primary-color);
}

/* 3-Column Grid */
.sheet-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 1200px) {
    .sheet-grid {
        grid-template-columns: 1fr 1fr;
    }
    .column-right {
        grid-column: 1 / -1;
    }
}

@media (max-width: 768px) {
    .sheet-grid {
        grid-template-columns: 1fr;
    }
}

.column-left, .column-center, .column-right {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.column-title {
    font-family: 'Cinzel', serif;
    font-size: 1.3rem;
    color: var(--primary-color);
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
    letter-spacing: 0.05em;
}

/* Component Cards */
.component-card {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.25rem;
}

.component-title {
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    color: var(--primary-color);
    margin: 0 0 1rem 0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

/* Attributes Grid */
.attributes-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.attribute-card {
    background: linear-gradient(135deg, var(--background-color) 0%, var(--card-background) 100%);
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 0.75rem;
    text-align: center;
    transition: transform 0.2s, border-color 0.2s;
}

.attribute-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-color);
}

.attribute-label {
    font-weight: bold;
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.attribute-score {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-color);
    margin: 0.25rem 0;
}

.attribute-modifier {
    font-size: 1.1rem;
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

/* Dice Roll Buttons */
.btn-roll-dice {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
}

.btn-roll-dice:hover {
    background: var(--accent);
    transform: scale(1.05);
}

.btn-roll-dice:active {
    transform: scale(0.95);
}

.btn-roll-dice.inline {
    padding: 0.2rem 0.5rem;
    font-size: 0.85rem;
    margin-left: 0.5rem;
}

/* Weapon Cards */
.weapon-card {
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.weapon-card:last-child {
    margin-bottom: 0;
}

.weapon-name {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--primary-color);
    margin-bottom: 0.75rem;
}

.weapon-stats {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.weapon-stat {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
}

.stat-label {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.stat-value {
    flex: 1;
    color: var(--text-color);
}

/* Armor Display */
.armor-display {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.armor-stat {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
    background: var(--background-color);
    border-radius: 4px;
}

/* Health Display */
.health-display {
    margin-top: 0.5rem;
}

.hp-bar-container {
    position: relative;
    background: var(--background-color);
    border: 2px solid var(--border-color);
    border-radius: 8px;
    height: 40px;
    overflow: hidden;
}

.hp-bar {
    height: 100%;
    transition: width 0.3s, background-color 0.3s;
}

.hp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--text-color);
    text-shadow: 0 0 3px rgba(255,255,255,0.8);
}

.temp-hp {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #2196f3;
    color: white;
    border-radius: 4px;
    text-align: center;
    font-weight: 600;
}

/* Info Lists */
.info-list {
    margin: 0;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem 1rem;
}

.info-list dt {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.info-list dd {
    margin: 0;
    color: var(--text-color);
}

.entity-list {
    margin: 0;
    padding: 0;
    list-style: none;
}

.entity-list li {
    padding: 0.5rem;
    background: var(--background-color);
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.entity-list li:last-child {
    margin-bottom: 0;
}

.mono {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

/* Roll History */
.roll-history-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.roll-history {
    max-height: 400px;
    overflow-y: auto;
}

.roll-history-empty {
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
    padding: 2rem;
}

.roll-entry {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: all 0.3s;
}

.roll-entry:last-child {
    margin-bottom: 0;
}

.roll-entry.roll-rolling {
    border-color: #2196f3;
    background: #e3f2fd;
}

.roll-entry.roll-success {
    border-color: #4caf50;
}

.roll-entry.roll-error {
    border-color: #f44336;
    background: #ffebee;
}

.roll-animate {
    animation: rollPulse 0.5s;
}

@keyframes rollPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.roll-label {
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.roll-notation {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.roll-total {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-color);
    text-align: center;
    margin: 0.5rem 0;
}

.roll-total.critical-success {
    color: #4caf50;
    text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
}

.roll-total.critical-failure {
    color: #f44336;
    text-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
}

.roll-breakdown {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
}

.roll-status {
    font-style: italic;
    color: var(--text-muted);
}

.roll-error {
    color: #f44336;
    font-weight: 600;
}

/* Component Display Data */
.component-data {
    margin: 0;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem 1rem;
}

.component-data dt {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.component-data dd {
    margin: 0;
    color: var(--text-color);
}
</style>
{% endblock %}
